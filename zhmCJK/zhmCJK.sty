%% Copyright (C) 2012 by Leo Liu <leoliu.pku@gmail.com>
%% --------------------------------------------------------------------------
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%% 
\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesPackage{zhmCJK}
         [2012/02/02 v0.1 setup CJK fonts with zhmetrics]


\RequirePackage{CJKutf8}
\RequirePackage{CJKspace}
\AtEndOfPackage{\CJK@makeActive}
\AtBeginDocument{\begin{CJK*}{UTF8}{\CJKrmdefault}}
\AtEndDocument{\end{CJK*}}

\newcount\zhmfamcnt

\def\zhmdefinefont#1{
  \DeclareFontFamily{C70}{#1}{\hyphenchar \font-1}
  \DeclareFontShape{C70}{#1}{m}{n}{<-> CJK * zhm\the\zhmfamcnt}{\CJKnormal}
  \DeclareFontShape{C70}{#1}{bx}{n}{<-> CJKb * zhm\the\zhmfamcnt}{\CJKbold}
}

\RequirePackage{ifpdf}

\ifpdf
  \def\zhm@mapline#1{%
    \pdfmapline{=zhm\the\zhmfamcnt @Unicode@ <#1}}
\else
  \def\zhm@mapline#1{%
    \special{pdf:mapline + zhm\the\zhmfamcnt @Unicode@ unicode #1}}
\fi

\def\setCJKfamilyfont#1#2{
  \advance\zhmfamcnt\@ne
  \ifnum\zhmfamcnt>\@xxxii
    \PackageError{zhmCJK}%
      {No more CJK font families can be setup.}%
      {There are at most 32 families setup by zhmCJK.}
  \else
    \scantokens\expandafter{\zhmdefinefont{#1}}
    \AtBeginDvi{\zhm@mapline{#2}}
    \AtBeginDocument{% for eso-pic etc.
      \@ifpackageloaded{atbegshi}{\AtBeginShipoutFirst{%
        \zhm@mapline{#2}}}{}}
  \fi
}
\@onlypreamble\setCJKfamilyfont

\def\setCJKmainfont{%
  \setCJKfamilyfont{\CJKrmdefault}}

\def\setCJKsansfont{%
  \setCJKfamilyfont{\CJKsfdefault}}

\def\setCJKmonofont{%
  \setCJKfamilyfont{\CJKttdefault}}

\providecommand\CJKrmdefault{rm}
\providecommand\CJKsfdefault{sf}
\providecommand\CJKttdefault{tt}
\providecommand\CJKfamilydefault{\CJKrmdefault}

\DeclareRobustCommand\normalfont
        {\CJKfamily{\CJKfamilydefault}%
         \usefont\encodingdefault
                 \familydefault
                 \seriesdefault
                 \shapedefault
         \relax}
\let\reset@font\normalfont

\DeclareRobustCommand\rmfamily
        {\not@math@alphabet\rmfamily\mathrm
         \fontfamily\rmdefault\CJKfamily{\CJKrmdefault}\selectfont}

\DeclareRobustCommand\sffamily
        {\not@math@alphabet\sffamily\mathsf
         \fontfamily\sfdefault\CJKfamily{\CJKsfdefault}\selectfont}

\DeclareRobustCommand\ttfamily
        {\not@math@alphabet\ttfamily\mathtt
         \fontfamily\ttdefault\CJKfamily{\CJKttdefault}\selectfont}

\endinput

