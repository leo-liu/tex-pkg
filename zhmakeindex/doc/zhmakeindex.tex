\documentclass[UTF8,hyperref,nofonts]{ctexart}
\xeCJKsetup{AutoFakeBold=false,PunctStyle=hangmobanjiao,Verb=true}
\setCJKmainfont[ItalicFont=FandolKai]{FandolSong}
\setCJKsansfont{FandolHei}
\setCJKmonofont{FandolFang}

\usepackage[a4paper,centering,margin=1.2in]{geometry}

\CTEXsetup[format=\bfseries\Large]{section}

\bibliographystyle{plain}

\usepackage{ragged2e}

\usepackage{booktabs}
\usepackage{longtable}
\usepackage{tabu}

\usepackage{caption}
\captionsetup[table]{font=small,position=top,skip=1ex}

\usepackage{makeidx}
\makeindex

\usepackage{fancyvrb}
\fvset{formatcom=\xeCJKVerbAddon}
\usepackage{shortvrb}
\AtBeginDocument{
  \MakeShortVerb\|
  \MakeShortVerb\"
}

\usepackage{hyperref}
\def\tableautorefname{表}

\usepackage{xspace}

\newcommand\pkg[1]{\textsf{#1}\index{#1@\textsf{#1}}}
\newcommand\zhm{\pkg{zhmakeindex}\xspace}
\newcommand\meta[1]{$\langle\textnormal{\itshape#1}\rangle$}
\newcommand\optional[1]{\textnormal{[}#1\textnormal{]}}
\def\defchar#1{\begingroup\lccode`~=`#1\lowercase{\endgroup\def~}}
\newenvironment{syntax}{%
  \quote\ttfamily
  \catcode`<\active  \defchar<##1>{\meta{##1}}
  \catcode`[\active  \defchar[##1]{\optional{##1}}
}{\endquote}
\newcommand\email{\nolinkurl}

\title{\zhm\thanks{版本 1.0} 中文索引处理程序}
\author{刘海洋}
\date{2014 年 2 月 6 日}

\begin{document}

\maketitle

\section{命令行}

\begin{syntax}
\halign{#&#\hfil\cr
zhmakeindex &[-c] [-i] [-o~<ind>] [-q] [-r] [-s~<sty>] [-t~<log>]\cr
            &[-enc~<enc>] [-senc~<senc>] [-strict] [-z~<sort>]\cr
            &[<idx0> <idx1> <idx2> ...]\cr
}
\end{syntax}

\section{简介}

\zhm 是一个通用的中文多级索引处理程序，它从一个或多个输入文件读入索引项，将其
内容按指定的方式分组、排序，然后按格式将整理好的索引输出到文件。索引项可以有 3
个级别（0, 1, 2）的嵌套。\zhm 主要用于 \LaTeX{} 索引的处理，其功能和用法与
\pkg{makeindex}\cite{Rodgers1991} 相似，并支持中文的分组与排序。

输入与输出文件的格式由一个格式文件确定。默认的输入/输出是 ".idx"/".ind" 格式
的，即 \LaTeX{} 格式的索引文件。

如果没有显式指定，第一个输入文件（\meta{idx0}）的主文件名将用于确定输出和日志
文件的主文件名。对每个输入文件名 \meta{idx0}, \meta{idx1}, \ldots, \zhm 会首先
查找这个名字的文件；如果找不到且文件名没有后缀，则加上 ".idx" 后缀查找此文件；
如果还找不到文件，\zhm 则会中止。

如果只有一个输入文件，并且没有显式用 "-s" 选项指定格式文件，\zhm 会使用后缀为
".mst" 的默认格式文件（如果存在的话）。


\section{选项说明}

\subsection{与 \pkg{makeindex} 相同的选项}

\begin{description}
  \item[-c] 压缩索引项排序键前后的空格。默认情况下，索引键的空格会被保留。
  \item[-i] 从标准输入流（"stdin"）读入索引项。如果使用了该选项，并且没有使用
    "-o" 选项，则排序后的索引将输出到标准输出流（"stdout"）。
  \item[-o~\meta{ind}] 设置输出索引文件为 \meta{ind}。如果没有指定该选项，默认
    的输出文件名是第一个输入文件 \meta{idx0} 的主文件名加上 ".ind" 的扩展名。
  \item[-q] 静默模式，不向标准错误流（"stderr"）显示信息。默认情况下处理过程与
    错误信息会同时在 "stderr" 与日志文件中输出。
  \item[-r] 禁止隐式页码区间构造，要求页码区间必须使用显式区间符号生成。见
    第~\ref{sec:sepcialeffects} 节的说明。默认情况下，三个或三个以上连续的页码
    会自动合并为一个页码区间（如 1--5）。
  \item[-s~\meta{sty}] 设置 \meta{sty} 为格式文件。没有默认值。\zhm 会首先在当
    前目录查找格式文件，如果找不到则调用 \TeX{} 发行版的 \pkg{kpathsea} 库在
    TEXMF 树中查找。
  \item[-t~\meta{log}] 设置 \meta{log} 为日志文件。默认情况下，会使用第一个输
    入文件 \meta{idx0} 的主文件名加上 ".ilg" 后缀作为日志文件。
\end{description}

\subsection{\zhm 独有的选项}

\begin{description}
  \item[-enc~\meta{enc}] 设置输入输出文件的编码为 \meta{enc}。可选的编码包括
    "UTF-8", "UTF-16", "GB18030", "GBK" 和 "Big5"，不区分大小写。默认使用
    UTF-8 编码。
  \item[-senc~\meta{senc}] 设置读入格式文件的编码为 \meta{senc}。可选的编码与
    "-enc" 选项相同。默认使用 UTF-8 编码。
  \item[-strict] 严格区分不同嵌入命令的页码。默认情况下，在页码区间处理时，会
    将如果页码左区间的嵌入命令与右区间不匹配，会以左区间为准（部分 \LaTeX{} 文
    档会生成右区间命令缺失的索引项）；而如果使用 "-strict" 选项，则要求左右区
    间的命令类型必须严格匹配。
  \item[-z~\meta{sort}] 设置中文排序分组方式为 \meta{sort}。可选的中文排序分组
    方式如\autoref{tab:sort} 所示。默认按拼音排序分组。
\begin{table}[htbp]
\caption{\zhm 支持的中文排序分组方式}\label{tab:sort}
\begin{tabu} to \linewidth{ll>{\RaggedRight}X}
\toprule
选项 & 别名 & 意义 \\
\midrule
"pinyin" & "reading" & 按第一个汉字拼音首字母与西文混合分组，汉字按拼音
  排序。 \\
"bihua" & "stroke" & 汉字按笔画数与西文各自分组，按笔画数和笔顺排序。 \\
"bushou" & "radical" & 汉字按康熙字典部首与西文各自分组，按部首和除部首笔画数
  排序。 \\
\bottomrule
\end{tabu}
\end{table}
\end{description}

\subsection{未实现的选项}

\zhm 没有实现 \pkg{makeindex} 的 "-g", "-l", "-p", "-L", "-T" 选项。其中，选项
"-p" 依赖对 \TeX{} 编译的日志文件的解析，可能在未来版本实现；另外几个语言相关
的排序选项（"-g" 德文，"-T" 泰文，"-L" 做系统 locale 选择，"-l" 有关西文单词排
序）对中文索引意义较小，不在 \zhm 中实现。

\section{格式文件}

\zhm 的格式文件与标准 \pkg{makeindex} 语法完全相同，内容也基本上相同，同时增加
了少量控制中文分组输出的格式。可以在 \zhm 中使用标准 \pkg{makeindex} 的格式文
件。

格式文件指明了 ".idx" 输入文件和最终输入文件的格式。该文件在当前工作目录或在
TEXMF 树中由 \pkg{kpathsea} 库查找。一个格式文件由一组 \meta{关键字} \meta{属
性} 的列表组成。\meta{关键字} 分为输出和输出两类。\meta{关键字} \meta{属性} 对
儿不要求以任何顺序出现。以字符 \verb"%" 开头的行是注释。\meta{属性} 可以有不同
的类型，字符串是以任意双引号 |"| 或反引号 |`| 界定的串，字符是以单引号 |'| 界
定的单个字符，数字是一个整数。其中，双引号和单引号界定的串和字符，可以使用反斜
线 "\" 符号作为转义符，以得到特殊字符或引号本身；而反引号界定的串是 \zhm 特有
的功能，它不使用转义符。格式文件中没有指定的项目会使用其默认值。

\subsection{与 \pkg{makeindex} 兼容的格式}

\autoref{tab:oldinputstyle} 与\autoref{tab:oldoutputstyle} 的格式是在
\pkg{makeindex} 中有定义，同时也在 \zhm 中有支持的输入、输出格式。\zhm 的这部
分格式选项与 \pkg{makeindex} 意义相同，完全兼容。

\begin{longtabu*} to \linewidth{lll>{\RaggedRight}X}
\caption{与 \pkg{makeindex} 兼容的输入格式}\label{tab:oldinputstyle} \\
  \toprule
  关键字 & 类型 & 默认值 & 意义 \\
  \midrule
\endfirsthead
  \toprule
  关键字 & 类型 & 默认值 & 意义 \\
  \midrule
\endhead
  \bottomrule
\endfoot
  |keyword|  & 字符串 & |"\\indexentry"| & 索引命令 \\
  |arg_open|  & 字符 & |'{'| & 参数的开定界符 \\
  |arg_close|  & 字符 & |'}'| & 参数的闭定界符 \\
  |range_open|  & 字符 & |'('| & 页码范围的开定界符 \\
  |range_close|  & 字符 & |')'| & 页码范围的闭定界符 \\
  |level|  & 字符 & |'!'| & 索引项层次分隔符 \\
  |actual|  & 字符 & |'@'| & （用于排序的）实际键标志符 \\
  |encap|  & 字符 & "'|'" & 页码和特殊命令指示符 \\
  |quote|  & 字符 & |'"'| & 引号（转义符） \\
  |escape|  & 字符 & |'\\'| & 转义 |quote| 的符号，在它后面的引号不作转义符
解释 \\
\end{longtabu*}

\begin{longtabu*} to \linewidth{lll>{\RaggedRight}X}
\caption{与 \pkg{makeindex} 兼容的输出格式}\label{tab:oldoutputstyle} \\
  \toprule
  关键字 & 类型 & 默认值 & 意义 \\
  \midrule
\endfirsthead
\toprule
关键字 & 类型 & 默认值 & 意义 \\
\midrule
\endhead
\bottomrule
\endfoot
|preamble| &  字符串 & |"\\begin{theindex}\n"| & 索引导言代码\\
|postamble| &  字符串 & |"\n\n\\end{theindex}\n"| & 索引末尾代码\\
|setpage_prefix| &  字符串 & |"\n  \\setcounter{page}{"| & 页码设置前缀\\
|setpage_suffix| &  字符串 & |"}\n"| & 页码设置后缀\\
|group_skip| &  字符串 & |"\n\n  \\indexspace\n"| & 组间垂直间距\\
|headings_flag| &  数字 & |0| & 标明新字母（分组）的旗标\\
|heading_prefix| &  字符串 & |""| & 新字母（分组）标题前缀\\
|heading_suffix| &  字符串 & |""| & 新字母（分组）标题后缀\\
|symhead_positive| &  字符串 & |"Symbols"| & 当旗标 |headings_flag| 为正数时，符号的标题\\
|symhead_negative| &  字符串 & |"symbols"| & 当旗标 |headings_flag| 为负数时，符号的标题\\
|numhead_positive| &  字符串 & |"Numbers"| & 当旗标 |headings_flag| 为正数时，数字的标题\\
|numhead_negative| &  字符串 & |"numbers"| & 当旗标 |headings_flag| 为负数时，数字的标题\\
|item_0| &  字符串 & |"\n  \\item "| & 第 0 级条目间分隔\\
|item_1| &  字符串 & |"\n    \\subitem "| & 第 1 级条目间分隔\\
|item_2| &  字符串 & |"\n      \\subsubitem "| & 第 2 级条目间分隔\\
|item_01| &  字符串 & |"\n    \\subitem "| & 第 0/1 级条目间分隔\\
|item_x1| &  字符串 & |"\n    \\subitem "| & 第 0/1 级条目间分隔，其中第 0 级无页码\\
|item_12| &  字符串 & |"\n      \\subsubitem "| & 第 1/2 级条目间分隔\\
|item_x2| &  字符串 & |"\n      \\subsubitem "| & 第 1/2 级条目间分隔，其中第 1 级无页码\\
|delim_0| &  字符串 & |", "| & 第 0 级条目与页码分隔\\
|delim_1| &  字符串 & |", "| & 第 1 级条目与页码分隔\\
|delim_2| &  字符串 & |", "| & 第 2 级条目与页码分隔\\
|delim_n| &  字符串 & |", "| & 多个页码的分隔\\
|delim_r| &  字符串 & |"--"| & 页码范围符号\\
|delim_t| &  字符串 & |""| & 将插入到在页码列表末尾。如果页码列表为空，此项无
效果。 \\
|encap_prefix| &  字符串 & |"\\"| & 页码特殊指令前缀\\
|encap_infix| &  字符串 & |"{"| & 页码特殊指令中缀\\
|encap_suffix| &  字符串 & |"}"| & 页码特殊指令后缀\\
|page_precedence| &  字符串 & |"rnaRA"| & 不同类型页码的次序，默认值表示小写
  罗马、阿拉伯数字、小写字母、大写罗马、大写字母\\
|suffix_2p| & 字符串 & |""| & 在 2 页的页码范围中代替 |delim_r| 和第二个页码\\
|suffix_3p| & 字符串 & |""| & 在 3 页的页码范围中代替 |delim_r| 和后面的页码\\
|suffix_mp| & 字符串 & |""| & 在更多页的页码范围中代替 |delim_r| 和后面的页码\\
\end{longtabu*}

\subsection{\zhm 特有的格式}

\zhm 定义了一些特有的格式（\autoref{tab:newoutputstyle}），用来控制按笔画数或
部首分组时，分组名的输出格式。

\begin{table}[htbp]
\caption{\zhm 特有的输出格式}\label{tab:newoutputstyle}
\begin{tabu*} to \linewidth{lll>{\RaggedRight}X}
\toprule
关键字 & 类型 & 默认值 & 意义 \\
\midrule
  "stroke_prefix"             & 字符串 & |""| & 笔画数前缀 \\
  "stroke_suffix"             & 字符串 & |" 画"| & 笔画数后缀 \\
  "radical_prefix"            & 字符串 & |""| & 部首前缀 \\
  "radical_suffix"            & 字符串 & |"部"| & 部首后缀 \\
  "radical_simplified_flag"   & 数字 & 1 & 是否输出简化部首的标志 \\
  "radical_simplified_prefix" & 字符串 & |"（"| & 简化部首前缀 \\
  "radical_simplified_suffix" & 字符串 & |"）"| & 简化部首后缀 \\
\bottomrule
\end{tabu*}
\end{table}

\subsection{未实现的 \pkg{makeindex} 格式}

\autoref{tab:unsupportedinputstyle} 和\autoref{tab:unsupportedoutputstyle} 中
给出的是在标准的 \pkg{makeindex} 中定义，但在 \zhm 中没有实现对应功能的格式。
格式文件中如果出现这些格式，\zhm 将会忽略它们。

\begin{table}[htbp]
\caption{未实现的输入格式}\label{tab:unsupportedinputstyle}
\begin{tabu*} to \linewidth{lll>{\RaggedRight}X}
\toprule
关键字 & 类型 & 默认值 & 意义 \\
\midrule
  |page_compositor| &  字符串 & |"-"| & 复合页码分隔符 \\
\bottomrule
\end{tabu*}
\end{table}

\begin{table}[htbp]
\caption{未实现的输出格式}\label{tab:unsupportedoutputstyle}
\begin{tabu*} to \linewidth{lll>{\RaggedRight}X}
\toprule
关键字 & 类型 & 默认值 & 意义 \\
\midrule
|line_max| &  数字 & |72| & 最大行长度，超出长度会自动折行\\
|indent_space| &  字符串 & |"\t\t"| & 自动折行的缩进\\
|indent_length| &  数字 & |16| & |indent_space| 的长度\\
\bottomrule
\end{tabu*}
\end{table}

\subsection{格式文件示例}

合法的 \pkg{makeindex} 格式文件都是合法的 \zhm 格式文件。\LaTeXe{} 的
\pkg{doc} 包附带的 \path{gind.ist} 和 \path{gglo.ist} 就是两个实际的例子。此
外，\pkg{makeindex} 手册页 \cite{Rodgers1991} 也给出了几个有用的例子。

下面是本文档使用的格式文件，注意其中反引号格式的串是 \zhm 特有的：
\VerbatimInput[numbers=left]{zhmakeindex.mst}

\section{排序细节}

\subsection{分组}

\subsection{条目排序}

\subsection{页码排序与合并}

\section{特殊效果}
\label{sec:sepcialeffects}

\section{与 \pkg{makeindex} 的比较}

\section{版权与许可}
\index{版权}\index{许可}

版权所有：2014 年，刘海洋 \email{leoliu.pku@gmail.com}

\index{LPPL}
本作品可在《the \LaTeX{} Project Public License》1.3 或更高版本的条件下发布与
修改。最新版本的 LPPL 许可证可以在
\begin{quote}
  \url{http://www.latex-project.org/lppl.txt}
\end{quote}
下载；该许可证同时也包含在所有最新的 \LaTeX{} 发行版中。

本作品目前处于 LPPL 维护状态“author-maintained”。

当前维护者是刘海洋。

\index{源文件}
本作品包括 \zhm 的程序及文档，由如下源文件：
\begin{verbatim}
build-dist.cmd
input.go
main.go
numberedreader.go
output.go
radicalstrokes.go
radical_collator.go
readings.go
reading_collator.go
sorter.go
strokes.go
stroke_collator.go
style.go
style_test.go
doc/zhmakeindex.bib
doc/zhmakeindex.mst
doc/zhmakeindex.tex
kpathsea/dynamic_other.go
kpathsea/dynamic_windows_386.go
kpathsea/kpathsea.go
maketables/make-table.cmd
maketables/maketables.go
\end{verbatim}
以及编译源文件得到的二进制文件 \path{zhmakeindex.exe} 或 \path{zhmakeindex}、
PDF 文档 \path{zhmakeindex.pdf} 组成。

\index{Unicode}
大部分汉字数据来自 Unicode 项目（\url{http://www.unicode.org/}）：
\begin{verbatim}
maketables/CJKRadicals.txt
maketables/Unihan_DictionaryLikeData.txt
maketables/Unihan_RadicalStrokeCounts.txt
maketables/Unihan_Readings.txt
\end{verbatim}

\index{海峰五笔}
部分字形数据来自海峰五笔项目（\url{http://okuc.net/sunwb/}）：
\begin{verbatim}
maketables/sunwb_strokeorder.txt
\end{verbatim}

\bibliography{zhmakeindex}

\printindex

\end{document}

vim:tw=78
